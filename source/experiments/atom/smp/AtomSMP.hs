module AtomSMP
  ( compileSMP )
where

import Control.Monad (forM_)
import Data.Word

import Language.Atom


-- Parameters ----------------------------------------------------------

-- Time in ticks between each node's activity
initPeriod     = 5
sourcePeriod   = 5
recvPeriod     = 5


-- Messages ------------------------------------------------------------

type MsgType = Word64

-- | Special message value indicating "no message present"
missingMsgValue :: MsgType
missingMsgValue = 0

-- | Special message value indicating "correct (intended) message"
goodMsg :: E MsgType
goodMsg = Const 1


-- SMP Spec ------------------------------------------------------------

-- | Top level rule
smp :: Atom ()
smp = do
  -- setup channel for communication between source and receiver
  (s2rIn, s2rOut) <- channel "s2r" missingMsgValue

  -- declare system nodes:

  -- used to print out probe values only
  sysInit

  -- source:
  source s2rIn
  -- receiver:
  recv s2rOut


-- Init ----------------------------------------------------------------

-- | Print all probe values at phase 0
sysInit :: Atom ()
sysInit = period initPeriod . exactPhase 0 . atom "sysInit" $ do
  printAllProbes


-- Source --------------------------------------------------------------

-- | Source node
source :: ChanInput  -- ^ channel input source will put messages on
       -> Atom ()
source c = period sourcePeriod . atom "source" $ do
  done <- bool "done" False
  probe "source.done" (value done)

  cond $ not_ (value done)
  writeChannel c goodMsg  -- send 'goodMsg' to receiver
  done <== Const True

  printAllProbes

-- Receiver -----------------------------------------------------------

-- | Receiver node
recv :: ChanOutput  -- ^ channel output that receiver listens to
     -> Atom ()
recv c = period recvPeriod . atom "recv" $ do
  done <- bool "done" False
  probe "recv.done" (value done)
  vote <- word64 "vote" missingMsgValue
  probe "recv.vote" (value vote)

  condChannel c           -- execute only if channel 'c' has new message
  vote <== readChannel c  -- read message and assign to 'vote'
  done <== Const True

  printAllProbes

printAllProbes :: Atom ()
printAllProbes = mapM_ printProbe =<< probes


-- Code Generator ------------------------------------------------------

-- | Invoke the atom compiler, generating 'om1.{c,h}'
-- Also print out info on the generated schedule.
compileSMP :: IO ()
compileSMP = do
  (sched, _, _, _, _) <- compile "smp" cfg smp
  putStrLn $ reportSchedule sched
  where
    cfg = defaults { cCode = prePostCode }

-- | Custom pre-post code for generated C
prePostCode :: [Name] -> [Name] -> [(Name, Type)] -> (String, String)
prePostCode _ _ _ =
  ( unlines [ "#include <stdio.h>"
            , "#include <unistd.h>"
            , ""
            , "// ---- BEGIN of source automatically generated by Atom ----"
            ]
  , unlines [ "// ---- END of source automatically generated by Atom ----"
            , ""
            , "int main(int argc, char **argv) {"
            , "  while(1) { smp(); usleep(1000); }"
            , "}"
            ]
  )
