module AtomOM1
  ( compileOM1 )
where

import Language.Atom


-- Parameters ----------------------------------------------------------

sourcePeriod = 20
observerPeriod = 20


-- Messages ------------------------------------------------------------

type MsgType = Word64

missingMsgValue :: MsgType
missingMsgValue = 0

msgVar :: Name -> MsgType -> Atom (V MsgType)
msgVar = flip word64 missingMsgValue


-- OM1 Spec ------------------------------------------------------------

om1 :: Atom ()
om1 = do
  c1v <- msgVar "c1v"
  c1 <- vchannel c1v  -- :: VChannel MsgType

  source c1

  observer c1


source :: VChannel MsgType -> Atom ()
source c1 = atom "source" $ do
  done <- bool "done" False
  msg  <- msgVar "msg" 1
  period sourcePeriod $ do
    cond $ not_ (value done)
    updateVChannel c1 (value msg)
    done <== True


observer :: VChannel MsgType -> Atom ()
  observer c1 = period observerPeriod $ atom "observer" $ do
    v <- readVChannel c1  -- disruptive
    probe "c1" v


-- Variable Channels ---------------------------------------------------

type VChannel a = Channel (V a)

vchannel :: V a -> Atom (VChannel a)
vchannel = channel

writeVChannel :: VChannel a -> Atom ()
writeVChannel = writeChannel

readVChannel :: VChannel a -> Atom (E a)
readVChannel = value <$> readChannel c

updateVChannel :: VChannel a -> E a -> Atom ()
updateVChannel (VChannel var _) expr = do
  var <== expr


-- Code Generator ------------------------------------------------------

-- | Invoke the atom compiler, generating 'om1.{c,h}'
-- Also print out info on the generated schedule.
compileOM1 :: IO ()
compileOM1 = do
  (devSched, _, _, _, _) <- compile "om1" cfg om1
  putStrLn $ reportSchedule devSched
  putStrLn $ reportSchedule dvrSched
  where
    cfg = defaults { cCode = prePostCode }

-- | Custom pre-post code for generated C
prePostCode :: [Name] -> [Name] -> [(Name, Type)] -> (String, String)
prePostCode _ _ _ =
  ( unlines [ "// ---- This source is automatically generated by Atom ----"
            ]
  , unlines [ "// ---- This source is automatically generated by Atom ----"
            ]
  )
